# VirtualMachineSnapshotManager

## Overview

The `VirtualMachineSnapshotManager` class provides an interface to manage VirtualBox virtual machines (VMs), specifically focusing on VM snapshots. It allows you to perform operations like creating, restoring, and deleting snapshots, starting and stopping the VM, and handling session locks. The class also ensures that environment variables (such as VM name, user credentials, and VBoxManage path) are loaded from a `.env` file for configuration.

This utility is useful for automating the management of VirtualBox VMs, especially when dealing with automated tests or repeated setup scenarios where snapshots are used to restore a clean state.

## Features

- **Snapshot Management**: Create, restore, and delete snapshots for a VirtualBox VM.
- **VM Power Control**: Start or power off the VM.
- **Session Handling**: Check for active VM session locks and release them.
- **Environment Configuration**: Load VM configuration details from an `.env` file, such as VM name, base snapshot, and VM credentials.
- **Error Handling**: Comprehensive error logging and handling for all actions.

## Requirements

- Python 3.6 or higher
- `paramiko` package for SSH and subprocess handling.
- `python-dotenv` for loading environment variables from a `.env` file.
- `VBoxManage.exe` must be installed and properly configured (for Windows users).
- VirtualBox must be installed and accessible from the command line.

## Installation

1. Clone or download the repository containing this script.
2. Install the necessary Python packages by running:

   ```bash
   pip install python-dotenv paramiko
   ```

3. Make sure that `VBoxManage` (VirtualBox CLI) is installed on your system, and its path is correctly set in the `.env` file.

4. Create a `.env` file in the same directory as the script with the following content:

   ```dotenv
   VM_NAME_WINDOWS=Your_VM_Name
   BASE_SNAPSHOT_NAME=Base_Snapshot
   TEST_SNAPSHOT_NAME=Test_Snapshot
   VM_USER_WINDOWS=Your_VM_User
   VM_PASSWORD_WINDOWS=Your_VM_Password
   VBOXMANAGE_PATH_WINDOWS="C:\\Program Files\\Oracle\\VirtualBox\\VBoxManage.exe"
   ```

## Usage

The script is designed to be run as a standalone program. When executed, it will manage the snapshots and VM operations as described below:

1. **Shut down the VM** if it's running.
2. **Restore the base snapshot** specified in the `.env` file.
3. **Delete the old test snapshot** (if it exists).
4. **Create a new test snapshot** for subsequent tests.
5. **Start the VM** for testing or other operations.
6. **Release any locked sessions** to prevent further issues.

### Example

```python
from snapshot_manager import VirtualMachineSnapshotManager

# Create an instance of the VirtualMachineSnapshotManager
vm_manager = VirtualMachineSnapshotManager()

# Run the snapshot management and VM start routine
vm_manager.manage_snapshots_and_run_vm()
```

## Methods

### `__init__(self)`
- Initializes the object and loads environment variables from the `.env` file.
- Sets up the necessary attributes, including the VirtualBox manager and VM details.

### `initialize_virtualbox(self)`
- Initializes the VirtualBox manager and session for the VM.
- Returns `True` if successful, `False` otherwise.

### `locate_machine(self)`
- Locates the specified VM by name in VirtualBox.
- Returns `True` if the machine is found, `False` otherwise.

### `power_off_machine(self)`
- Powers off the VM if it is running.

### `start_vm(self)`
- Starts the VM in headless mode.

### `restore_snapshot(self, snapshot_name)`
- Restores the VM to the specified snapshot.

### `delete_snapshot(self, snapshot_name)`
- Deletes the specified snapshot.

### `create_snapshot(self, snapshot_name, snapshot_description="")`
- Creates a snapshot of the VM with an optional description.

### `check_session_state(self)`
- Checks if the VM session is currently locked by another process.

### `release_session(self)`
- Releases the VM session lock if it exists.

### `manage_snapshots_and_run_vm(self)`
- Manages snapshots (restore, delete, create) and starts the VM for testing.
- This is the main method that runs the entire sequence of operations.

## Error Handling

The script uses `try`-`except` blocks to catch and handle errors. It prints the error messages to the console for debugging purposes. In case of failures, the script will log the specific error encountered and continue to the next step where applicable.

## Contributions

Feel free to fork the repository and contribute. If you encounter issues or have suggestions, please create an issue or submit a pull request.

## License

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.