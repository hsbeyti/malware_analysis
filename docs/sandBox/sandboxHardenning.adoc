### **Hardening Sandbox Windows 10 64 VM**

This document outlines the steps required to harden a Windows 10 VM used as a sandbox. It will cover the following:

- **VM Network Configuration**: Isolating the Windows VM in a safe network environment (Host-Only).
- **Disabling Guest Additions**: Preventing potential security issues caused by VirtualBox Guest Additions.
- **Network Restrictions**: Restricting internet access to the sandboxed Windows VM while still allowing SSH access from an Ubuntu VM acting as a gateway.
- **System Hardening**: Applying Windows security best practices to further secure the VM.

---

### **Step 1: Network Configuration for the Sandbox VM**

1. **Create Host-Only Network in VirtualBox**:
- Open **VirtualBox** and go to **File > Host Network Manager**.
- Click **Create** to set up a new **Host-Only Network** (e.g., `vboxnet0`).
- Ensure **DHCP Server** is disabled on this interface if you plan to assign static IPs manually or if you want Ubuntu to handle DHCP.

2. **Configure Both VMs to Use the Host-Only Network**:
- For **Ubuntu VM** and **Windows VM**:
- Go to **Settings > Network** in the VM settings.
- Select **Adapter 1** as **Host-Only Adapter**.
- In the dropdown menu, choose the network you just created (e.g., `vboxnet0`).

3. **Configure IP Addressing**:
- **Ubuntu VM**:
- Edit `/etc/netplan/00-installer-config.yaml` to set a static IP (e.g., `192.168.56.2`).
- Apply changes with:
```
sudo netplan apply
```
- **Windows VM**:
- Set a static IP for the **Host-Only Network Adapter** (e.g., `192.168.56.3`).
- Set **Gateway** as `192.168.56.1` (Ubuntu's IP) and **DNS Server** to `192.168.56.2`.

---

### **Step 2: Disabling VirtualBox Guest Additions**

1. **Why Disable Guest Additions?**
- Guest Additions can present vulnerabilities by enabling features like shared folders, clipboard sharing, and seamless windows that can be exploited.
- Disabling Guest Additions minimizes the potential attack surface.

2. **Disable Guest Additions in the Windows VM**:
- Open **Device Manager** in the Windows VM.
- Expand the **System Devices** section.
- Right-click on **VirtualBox Guest Additions** and click **Disable**.
- Reboot the VM to ensure changes take effect.

---

### **Step 3: Configure Ubuntu as Gateway and Restrict Internet Access for the Windows VM**

The **Ubuntu VM** will act as the gateway, and the **Windows VM** (sandbox) will be isolated from the internet.

1. **Install OpenSSH Server on Ubuntu** (Gateway VM):
- If OpenSSH is not installed, run:
```
sudo apt update
sudo apt install openssh-server
```
- Check the SSH service status:
```
sudo systemctl status ssh
```

2. **Allow SSH on Ubuntu's Firewall**:
- If you're using **UFW** on Ubuntu:
```
sudo ufw allow ssh
```

3. **Configure iptables on Ubuntu to Control Access**:
- Allow SSH from Windows VM:
```
sudo iptables -A INPUT -p tcp --dport 22 -s 192.168.56.3 -j ACCEPT
```
- Block internet access for Windows VM:
```
sudo iptables -A FORWARD -s 192.168.56.3 -o eth0 -j REJECT
```
- To make iptables rules persistent across reboots:
```
sudo apt install iptables-persistent
```

4. **Verify SSH Connection from Windows to Ubuntu**:
- On Windows, use **PuTTY** or **PowerShell** to SSH into Ubuntu:
```
ssh user@192.168.56.2
```

---
To allow malware to run effectively within the Windows VM sandbox while maintaining control and security, we need to carefully balance system hardening with enabling features that malware might depend on. Here’s the updated step to configure the Windows VM sandbox for controlled malware execution:

---

### **Step 4: Configure the Windows VM for Controlled Malware Execution**

#### **1. Disable SMBv1**
- Disabling SMBv1 reduces vulnerabilities without affecting most malware analysis:
- Open PowerShell as Administrator and run:
```powershell
Disable-WindowsOptionalFeature -Online -FeatureName smb1protocol
```

#### **2. Modify Windows Defender Settings**
- Windows Defender may interfere with malware execution. Adjust settings to minimize interference while retaining visibility:
- Go to **Settings > Update & Security > Windows Security > Virus & Threat Protection**.
- Turn off **Real-Time Protection** temporarily.
- Exclude specific folders (e.g., malware storage folders) in **Virus & Threat Protection Settings**:
- Add exclusions for the directory containing the malware and any analysis tools.

#### **3. Allow PowerShell Execution**
- Many malware samples rely on PowerShell for execution. Modify the execution policy to allow scripts to run:
```powershell
Set-ExecutionPolicy Unrestricted -Scope LocalMachine
```
- Ensure scripts used for analysis or control are signed or reviewed.

#### **4. Enable Necessary Services**
- Ensure required services are running for malware dependencies:
- **Windows Installer**
- **Networking services** (e.g., DHCP, DNS Client, Workstation)
- **Remote Procedure Call (RPC)** for system compatibility.
- Use `services.msc` to verify and enable these services as needed.

#### **5. Disable Automatic Updates**
- Prevent Windows from applying updates that might interfere with the analysis environment:
- Open **Services** (`services.msc`).
- Disable **Windows Update** and set the startup type to **Disabled**.

#### **6. Apply Windows Security Updates**
- Apply security patches **before** enabling malware execution to ensure the system is hardened against unintended exploitation:
- Run Windows Update manually and install the latest updates.

#### **7. Disable Unnecessary Features**
- Remove features that are not required for the malware's execution:
- Open **Control Panel > Programs > Turn Windows features on or off**.
- Disable:
- **Cortana**
- **OneDrive**
- **Windows Ink Workspace**

#### **8. Restrict Network Traffic**
- Ensure the malware cannot reach external networks while allowing simulated network activity within the sandbox:
- Use Windows Firewall to block all outbound traffic except for trusted local IP ranges (e.g., Ubuntu VM acting as the gateway):
- Open **Windows Defender Firewall with Advanced Security**.
- Create **Outbound Rules** to block all traffic except connections to the gateway.

#### **9. Isolate the Malware Execution Environment**
- Use a dedicated directory for malware execution. Set strict ACLs (Access Control Lists) to isolate this directory:
- Right-click the folder > **Properties > Security** and restrict access to necessary users or processes only.

#### **10. Monitor and Log Activity**
- Enable detailed logging for tracking malware behavior:
- Open **Event Viewer** and ensure the following logs are enabled:
- **Windows Logs > Application**
- **Windows Logs > Security**
- **Windows Logs > System**
- Enable **Process Creation Auditing** in Local Security Policy:
- Run `secpol.msc`.
- Navigate to **Advanced Audit Policy Configuration > System Audit Policies > Detailed Tracking**.
- Enable **Audit Process Creation** and **Audit Process Termination**.

---

### **Important Notes**
- **Snapshot Management**: Always take a clean snapshot of the VM before introducing malware. This allows for easy restoration after analysis.
- **Controlled Environment**: Ensure all communications are contained within the VM or your controlled network (e.g., using tools like INetSim or FakeNet-NG).
- **Disable Unnecessary User Interaction**: Use the Windows VM exclusively for malware analysis. Do not use it for browsing or other activities.

This configuration enables malware to operate within the sandbox while minimizing the risk of it escaping or interfering with the host system.

---

### **Step 5: Fake Internet Access for Windows VM**

In this step, we'll use **iptables** or **Windows Firewall** to restrict the sandbox VM’s internet access while still allowing SSH from Ubuntu.

1. **Set Up Fake DNS**:
- On the **Windows VM**, set the **DNS server** to `127.0.0.1` to block direct internet access. You can also configure a local fake DNS service on Ubuntu to handle DNS requests for the Windows VM.

2. **Windows Firewall Configuration**:
- Use **Windows Firewall** to restrict outgoing connections.
- Go to **Control Panel > System and Security > Windows Defender Firewall** > **Advanced Settings**.
- Create an **Outbound Rule** that blocks internet access, such as blocking **ports 80 (HTTP)** and **443 (HTTPS)**.

---
If your VM runs Windows 10, you can still simulate network activity for malware within the VM using tools like FakeNet-NG or configuring a local network environment on your host machine. Here's how to set this up:

---
To set up FakeNet-NG to run automatically at Windows startup or via a batch command, follow the steps below. This ensures the malware analysis environment is ready as soon as the Windows VM is started.

---
To set up FakeNet-NG to run automatically at Windows startup or via a batch command, follow the steps below. This ensures the malware analysis environment is ready as soon as the Windows VM is started.

---

### **Option: Configure FakeNet-NG to Run at Startup on Windows 10**

#### **1. Download and Extract FakeNet-NG**
1. Download FakeNet-NG from [GitHub](https://github.com/mandiant/flare-fakenet-ng).
2. Extract the files to a directory, e.g., `C:\tools\fakenet`.

#### **2. Configure FakeNet-NG**
1. Open `fakenet.conf` in a text editor (e.g., Notepad++ or Visual Studio Code).
2. Modify configurations based on the services you want to simulate. For example:
- For DNS:
```ini
[DNS]
Listener = dns
DefaultIP = 192.168.56.10  # Replace with your VM's IP address
```
- Customize other services as needed (HTTP, HTTPS, SMTP, etc.).

#### **3. Set Static IP Address for the VM**
1. Go to **Control Panel > Network and Sharing Center > Change Adapter Settings**.
2. Right-click the network adapter > **Properties**.
3. Select **Internet Protocol Version 4 (TCP/IPv4)** > **Properties**.
4. Set a static IP (e.g., `192.168.56.10`) and DNS Server as `192.168.56.10`.

#### **4. Create a Batch File to Start FakeNet-NG**
1. Open Notepad and paste the following:
```cmd
@echo off
cd C:\tools\fakenet
python fakenet.py --console
```
2. Save the file as `start_fakenet.bat` in the same directory as FakeNet-NG (`C:\tools\fakenet`).

#### **5. Schedule FakeNet-NG to Start Automatically**
1. Press `Win + R`, type `taskschd.msc`, and press Enter to open Task Scheduler.
2. Create a new task:
- In the **General** tab:
- Name: `FakeNet-NG Startup`.
- Select **Run whether user is logged on or not**.
- Check **Run with highest privileges**.
- In the **Triggers** tab:
- Click **New** and set the trigger to **At startup**.
- In the **Actions** tab:
- Click **New**, select **Start a Program**, and browse to `start_fakenet.bat`.
- In the **Conditions** tab:
- Uncheck **Start the task only if the computer is on AC power**.
- In the **Settings** tab:
- Check **Allow task to be run on demand**.

3. Save the task, and ensure it’s enabled.

#### **6. Verify FakeNet-NG Startup**
1. Reboot the Windows VM.
2. FakeNet-NG should start automatically. To confirm:
- Open Task Manager > **Processes** and look for `python.exe` running FakeNet-NG.
- Check logs in the FakeNet-NG directory for activity.

---

### **Notes**
- Ensure Python is installed and available in the system PATH.
- If you prefer not to use Task Scheduler, you can also place the `start_fakenet.bat` file in the **Startup folder**:
- Press `Win + R`, type `shell:startup`, and press Enter.
- Copy the `start_fakenet.bat` file into the folder.

This setup ensures FakeNet-NG is ready whenever the VM starts, facilitating seamless malware execution and analysis.
### **Notes**
- Ensure Python is installed and available in the system PATH.
- If you prefer not to use Task Scheduler, you can also place the `start_fakenet.bat` file in the **Startup folder**:
- Press `Win + R`, type `shell:startup`, and press Enter.
- Copy the `start_fakenet.bat` file into the folder.

This setup ensures FakeNet-NG is ready whenever the VM starts, facilitating seamless malware execution and analysis.

### **Option 3: Use a Host-Only or Internal Network**
To ensure the malware's network traffic remains isolated from your real network:
1. **Configure the VM's Network in VirtualBox:**
- Go to **Settings > Network** for the VM.
- Change the adapter to **Host-Only Adapter** or **Internal Network**.
- If using **Host-Only Adapter**, ensure VirtualBox Host-Only Network is configured.

2. **Simulate Network Inside the VM:**
- Use tools like FakeNet-NG or INetSim (if running in a secondary VM).
- Assign static IP addresses to the Windows 10 VM and the host-only network interface.

---

### **Option 4: Disable Internet Access but Allow Local Connections**
1. **Block Internet Access:**
- In Windows Firewall, create a rule to block all outbound traffic from the VM except for local IP ranges.

2. **Allow Local Network:**
- Configure exceptions in the firewall for connections to local IP addresses (e.g., `192.168.x.x`).

---

### **Final Note: Monitoring Traffic**
To observe the malware’s activity:
- Use **Wireshark** inside the VM or on the host.
- Configure FakeNet-NG or INetSim to log requests.

This setup ensures the malware believes it has access to a network while isolating it completely from the real world.
### **Step 6: Enable SSH Access Only Between VMs (Windows to Ubuntu)**

1. **Install an SSH Client on the Windows VM** (if not already installed):
- Use **PuTTY** or enable **OpenSSH** in **Windows Features**.

2. **Set Up SSH Agent for Password-less Login** (optional):
- On Ubuntu, generate an SSH key pair:
```
ssh-keygen -t rsa
```
- Copy the public key to the Windows VM:
```
ssh-copy-id user@192.168.56.3
```

---

### **Step 7: Testing the Setup**

1. **Test SSH Access**:
- Ensure that the **Windows VM** can SSH into the **Ubuntu VM**.
- Try accessing the internet from the Windows VM. It should be blocked.

2. **Test Isolation**:
- Verify that the **Windows VM** cannot access any external internet services.
- Use tools like **Wireshark** or **tcpdump** to monitor the network traffic.

---

### **Final Thoughts:**

- **Ubuntu VM** is configured as a gateway, allowing the **Windows VM** (sandbox) to access it via SSH.
- **Internet access** for the Windows VM is blocked, ensuring that any potentially dangerous activity within the sandbox does not affect the wider network.
- **Guest Additions** have been disabled to reduce the attack surface.
- The **Windows VM** has been hardened with security best practices.
- A **fake DNS setup** ensures that the sandbox cannot access the internet directly.

This setup creates a controlled environment for running potentially harmful code within the Windows VM, with minimal risk to the underlying system and network.