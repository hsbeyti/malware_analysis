### **Hardening Sandbox Windows 10 64 VM**

This document outlines the steps required to harden a Windows 10 VM used as a sandbox. It will cover the following:

- **VM Network Configuration**: Isolating the Windows VM in a safe network environment (Host-Only).
- **Disabling Guest Additions**: Preventing potential security issues caused by VirtualBox Guest Additions.
- **Network Restrictions**: Restricting internet access to the sandboxed Windows VM while still allowing SSH access from an Ubuntu VM acting as a gateway.
- **System Hardening**: Applying Windows security best practices to further secure the VM.

---

### **Step 1: Network Configuration for the Sandbox VM**

1. **Create Host-Only Network in VirtualBox**:
- Open **VirtualBox** and go to **File > Host Network Manager**.
- Click **Create** to set up a new **Host-Only Network** (e.g., `vboxnet0`).
- Ensure **DHCP Server** is disabled on this interface if you plan to assign static IPs manually or if you want Ubuntu to handle DHCP.

2. **Configure Both VMs to Use the Host-Only Network**:
- For **Ubuntu VM** and **Windows VM**:
- Go to **Settings > Network** in the VM settings.
- Select **Adapter 1** as **Host-Only Adapter**.
- In the dropdown menu, choose the network you just created (e.g., `vboxnet0`).

3. **Configure IP Addressing**:
- **Ubuntu VM**:
- Edit `/etc/netplan/00-installer-config.yaml` to set a static IP (e.g., `192.168.56.2`).
- Apply changes with:
```
sudo netplan apply
```
- **Windows VM**:
- Set a static IP for the **Host-Only Network Adapter** (e.g., `192.168.56.3`).
- Set **Gateway** as `192.168.56.1` (Ubuntu's IP) and **DNS Server** to `192.168.56.2`.

---

### **Step 2: Disabling VirtualBox Guest Additions**

1. **Why Disable Guest Additions?**
- Guest Additions can present vulnerabilities by enabling features like shared folders, clipboard sharing, and seamless windows that can be exploited.
- Disabling Guest Additions minimizes the potential attack surface.

2. **Disable Guest Additions in the Windows VM**:
- Open **Device Manager** in the Windows VM.
- Expand the **System Devices** section.
- Right-click on **VirtualBox Guest Additions** and click **Disable**.
- Reboot the VM to ensure changes take effect.

---

### **Step 3: Configure Ubuntu as Gateway and Restrict Internet Access for the Windows VM**

The **Ubuntu VM** will act as the gateway, and the **Windows VM** (sandbox) will be isolated from the internet.

1. **Install OpenSSH Server on Ubuntu** (Gateway VM):
- If OpenSSH is not installed, run:
```
sudo apt update
sudo apt install openssh-server
```
- Check the SSH service status:
```
sudo systemctl status ssh
```

2. **Allow SSH on Ubuntu's Firewall**:
- If you're using **UFW** on Ubuntu:
```
sudo ufw allow ssh
```

3. **Configure iptables on Ubuntu to Control Access**:
- Allow SSH from Windows VM:
```
sudo iptables -A INPUT -p tcp --dport 22 -s 192.168.56.3 -j ACCEPT
```
- Block internet access for Windows VM:
```
sudo iptables -A FORWARD -s 192.168.56.3 -o eth0 -j REJECT
```
- To make iptables rules persistent across reboots:
```
sudo apt install iptables-persistent
```

4. **Verify SSH Connection from Windows to Ubuntu**:
- On Windows, use **PuTTY** or **PowerShell** to SSH into Ubuntu:
```
ssh user@192.168.56.2
```

---

### **Step 4: System Hardening on the Windows VM**

To further harden the Windows VM, apply the following best practices:

1. **Disable SMBv1**:
- Open **PowerShell** as Administrator and run:
```
Disable-WindowsOptionalFeature -Online -FeatureName smb1protocol
```

2. **Enable Windows Defender**:
- Ensure **Windows Defender** is enabled and actively running.
- Go to **Settings > Update & Security > Windows Security** and turn on **Virus & Threat Protection**.

3. **Restrict PowerShell Execution**:
- Set the execution policy to **Restricted**:
```
Set-ExecutionPolicy Restricted -Scope LocalMachine
```

4. **Disable Unnecessary Services**:
- Disable unneeded services through **services.msc** (e.g., **Remote Desktop**, **Bluetooth**, etc.).

5. **Apply Windows Security Updates**:
- Regularly apply security patches and updates through **Windows Update**.

6. **Disable Unnecessary Features**:
- Disable Windows features like **Cortana**, **OneDrive**, **Windows Ink**.

---

### **Step 5: Fake Internet Access for Windows VM**

In this step, we'll use **iptables** or **Windows Firewall** to restrict the sandbox VM’s internet access while still allowing SSH from Ubuntu.

1. **Set Up Fake DNS**:
- On the **Windows VM**, set the **DNS server** to `127.0.0.1` to block direct internet access. You can also configure a local fake DNS service on Ubuntu to handle DNS requests for the Windows VM.

2. **Windows Firewall Configuration**:
- Use **Windows Firewall** to restrict outgoing connections.
- Go to **Control Panel > System and Security > Windows Defender Firewall** > **Advanced Settings**.
- Create an **Outbound Rule** that blocks internet access, such as blocking **ports 80 (HTTP)** and **443 (HTTPS)**.

---
If your VM runs Windows 10, you can still simulate network activity for malware within the VM using tools like FakeNet-NG or configuring a local network environment on your host machine. Here's how to set this up:

---

### **Option 1: Use FakeNet-NG on Windows 10 VM**
FakeNet-NG is compatible with Windows and allows you to simulate a wide variety of internet services directly on the VM.

#### **Steps:**
1. **Download and Install FakeNet-NG:**
- Download FakeNet-NG from [GitHub](https://github.com/mandiant/flare-fakenet-ng).
- Extract the files to a directory of your choice.

2. **Configure FakeNet-NG:**
- Open the `fakenet.conf` file in a text editor.
- Customize the services to simulate (e.g., HTTP, HTTPS, DNS). Example for DNS redirection:
```
[DNS]
Listener = dns
DefaultIP = 192.168.0.100  # Replace with your VM's IP address
```

3. **Run FakeNet-NG:**
- Open a Command Prompt or PowerShell in the directory where you extracted FakeNet-NG.
- Run the following command:
```cmd
python fakenet.py
```
- Use the `--console` flag to see logs in real time:
```cmd
python fakenet.py --console
```

4. **Set the Network in the VM:**
- Open Windows Network Settings in the VM.
- Set a static IP address and DNS server to the VM's local IP (the same as in the `DefaultIP` setting above).

---

### **Option 2: Configure a Local DNS Server on the Host**
You can set up a DNS server on your host machine to simulate internet responses for the Windows 10 VM.

#### **Steps:**
1. **Install a DNS Server on the Host:**
- Use tools like **Simple DNS Plus** (Windows) or **dnsmasq** (Linux) to run a DNS server.

2. **Configure the DNS Server:**
- Add entries to map specific domain names to local IP addresses.
- Example (dnsmasq configuration):
```
address=/malicious.com/192.168.56.1
address=/example.com/192.168.56.1
```

3. **Set the Windows VM to Use the DNS Server:**
- Open **Network & Internet Settings** on the Windows 10 VM.
- Set the DNS server to the host machine's IP address.

---

### **Option 3: Use a Host-Only or Internal Network**
To ensure the malware's network traffic remains isolated from your real network:
1. **Configure the VM's Network in VirtualBox:**
- Go to **Settings > Network** for the VM.
- Change the adapter to **Host-Only Adapter** or **Internal Network**.
- If using **Host-Only Adapter**, ensure VirtualBox Host-Only Network is configured.

2. **Simulate Network Inside the VM:**
- Use tools like FakeNet-NG or INetSim (if running in a secondary VM).
- Assign static IP addresses to the Windows 10 VM and the host-only network interface.

---

### **Option 4: Disable Internet Access but Allow Local Connections**
1. **Block Internet Access:**
- In Windows Firewall, create a rule to block all outbound traffic from the VM except for local IP ranges.

2. **Allow Local Network:**
- Configure exceptions in the firewall for connections to local IP addresses (e.g., `192.168.x.x`).

---

### **Final Note: Monitoring Traffic**
To observe the malware’s activity:
- Use **Wireshark** inside the VM or on the host.
- Configure FakeNet-NG or INetSim to log requests.

This setup ensures the malware believes it has access to a network while isolating it completely from the real world.
### **Step 6: Enable SSH Access Only Between VMs (Windows to Ubuntu)**

1. **Install an SSH Client on the Windows VM** (if not already installed):
- Use **PuTTY** or enable **OpenSSH** in **Windows Features**.

2. **Set Up SSH Agent for Password-less Login** (optional):
- On Ubuntu, generate an SSH key pair:
```
ssh-keygen -t rsa
```
- Copy the public key to the Windows VM:
```
ssh-copy-id user@192.168.56.3
```

---

### **Step 7: Testing the Setup**

1. **Test SSH Access**:
- Ensure that the **Windows VM** can SSH into the **Ubuntu VM**.
- Try accessing the internet from the Windows VM. It should be blocked.

2. **Test Isolation**:
- Verify that the **Windows VM** cannot access any external internet services.
- Use tools like **Wireshark** or **tcpdump** to monitor the network traffic.

---

### **Final Thoughts:**

- **Ubuntu VM** is configured as a gateway, allowing the **Windows VM** (sandbox) to access it via SSH.
- **Internet access** for the Windows VM is blocked, ensuring that any potentially dangerous activity within the sandbox does not affect the wider network.
- **Guest Additions** have been disabled to reduce the attack surface.
- The **Windows VM** has been hardened with security best practices.
- A **fake DNS setup** ensures that the sandbox cannot access the internet directly.

This setup creates a controlled environment for running potentially harmful code within the Windows VM, with minimal risk to the underlying system and network.