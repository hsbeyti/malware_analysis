# VirtualMachineAutomation

## Overview

`VirtualMachineAutomation` is a Python-based program that automates the process of processing files (such as malware or goodware binaries) on a VirtualBox-managed Windows VM. The program interacts with VirtualBox to manage VM snapshots and run files in the VM, providing an environment for testing or analysis. It automates the following tasks:
- Load configuration from a `.env` file.
- Process files from a source directory.
- Instrument files on the VM.
- Manage VM snapshots (restore, delete, and create).
- Run the VM for testing and analysis.

This program is especially useful for running malware analysis or other automated testing scenarios, ensuring that each test starts from a clean VM snapshot.

## Features

- **File Processing**: Automatically processes all files from a specified source directory.
- **VM Management**: Uses VirtualBox to control the state of a Windows VM (e.g., powering on, off, and restoring snapshots).
- **Snapshot Management**: Supports snapshot restoration, deletion, and creation, ensuring a fresh state for each test.
- **Environment Configuration**: Loads environment variables from a `.env` file for flexibility and easier configuration.
- **Delay Mechanism**: Waits between actions to allow VM operations to complete, ensuring stability and reliability.
- **Malware and Goodware Handling**: Specifically designed to instrument files (e.g., malware or goodware) in the VM and observe their behavior.

## Requirements

- Python 3.6 or higher
- `paramiko` for SSH and subprocess management
- `python-dotenv` for loading environment variables
- `VirtualBox` must be installed and accessible from the command line
- A Windows VM set up in VirtualBox with the necessary permissions

## Installation

1. **Clone or download** the repository containing this script.
2. Install the necessary Python dependencies by running:

   ```bash
   pip install python-dotenv paramiko
   ```

3. Ensure that `VBoxManage` (VirtualBox CLI tool) is installed and its path is configured correctly.

4. Create a `.env` file in the root of your project with the following variables:

   ```dotenv
   LOCAL_SOURCE_DIR=/path/to/source/directory
   LOCAL_DEST_DIR=/path/to/destination/directory
   ```

    - `LOCAL_SOURCE_DIR`: Directory where files to be processed are stored.
    - `LOCAL_DEST_DIR`: Destination directory where processed files may be saved or logged.

5. Ensure the VirtualBox VM is set up correctly and that the required snapshots and configurations are in place.

## Usage

This program is designed to be run as a standalone application. Upon execution, it will:

1. **Load Configuration**: Reads environment variables from the `.env` file to get the source and destination directories.
2. **Process Files**: Loops through each file in the source directory and processes it.
    - If the file is valid (a regular file), it proceeds to handle the file on the VM.
3. **Instrument the File on the VM**: The file is processed in the VM, which can involve running malware analysis or similar tests.
4. **Manage Snapshots**: After processing the file, the VM is reset to a clean state by restoring a base snapshot, deleting the old test snapshot, and taking a new snapshot.
5. **Wait Intervals**: The script waits for the necessary amount of time between operations to ensure the VM and processes are stable.

### Example:

```bash
python main.py
```

### Flow of Execution:

1. **Load Environment Variables**: The script loads configuration from `.env`.
2. **Directory Checks**: It checks if the source directory exists and contains files.
3. **File Processing**: Each file is processed in sequence:
    - The file is "instrumented" on the VM using `VirtualBoxManagerHandler`.
    - The VM is then managed and a new snapshot is taken using `VirtualMachineSnapshotManager`.
4. **Wait Times**: The program pauses at specific points to allow for VM operations to complete, ensuring smooth execution.
5. **Completion**: Once all files are processed, the script completes and logs the success message.

### Example `.env` Configuration:

```dotenv
LOCAL_SOURCE_DIR=/path/to/source/files
LOCAL_DEST_DIR=/path/to/destination
```

## Methods Overview

### `main()`
The main entry point of the program. It loads environment variables, checks directories, and processes files. It also manages the VirtualBox VM, ensuring it is powered on, snapshots are correctly managed, and files are instrumented.

### `run(file_name)`
This method, defined within `VirtualBoxManagerHandler`, processes a single file (such as a malware or goodware binary) in the Windows VM. It instruments the file on the VM and observes its behavior.

### `manage_snapshots_and_run_vm()`
This method, defined within `VirtualMachineSnapshotManager`, manages snapshots. It powers off the VM, restores the base snapshot, deletes the old test snapshot, and creates a new snapshot. It then starts the VM for further testing.

## Error Handling

The script contains comprehensive error handling for different stages:
- If environment variables are missing or directories do not exist, the script will display an error and terminate.
- Errors during file processing, VM handling, or snapshot management will be logged for easy troubleshooting.

## Contributions

Feel free to fork the repository and contribute. If you encounter issues or have suggestions, please create an issue or submit a pull request.

## License

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.